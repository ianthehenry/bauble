#!/usr/bin/env bash

set -euo pipefail

rm -rf public/js/main.js

rollup_args="--no-treeshake --no-indent"
emcc_args="-O0"
if [[ $# -gt 0 && "$1" == "prod" ]]; then
  rollup_args="-p rollup-plugin-terser"
  emcc_args="-O3"
fi

node_modules/.bin/rollup main.ts \
  -f iife \
  -o public/js/main.js \
  -p @rollup/plugin-node-resolve \
  -p @rollup/plugin-typescript \
  $rollup_args

rm -rf public/js/janet.{js,wasm}

emcc \
  $emcc_args \
  -o public/js/janet.js \
  -I janet \
  janet/janet.c \
  driver.c \
  -lembind \
  -std=c11 \
  --embed-file shade.janet \
  --embed-file shapes.janet \
  -s EXPORTED_FUNCTIONS=['_run_janet'] \
  -s USE_WEBGL2=1 \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s AGGRESSIVE_VARIABLE_ELIMINATION=1 \
  -s EXPORTED_RUNTIME_METHODS=['ccall','cwrap']
