#!/usr/bin/env bash

set -euo pipefail

prod_build=false
build_html=true
build_js=true
build_wasm=true

for arg; do
  case "$arg" in
    --prod) prod_build=true ;;
    --wasm) build_js=false; build_html=false ;;
    --js) build_wasm=false; build_html=false ;;
    --html) build_wasm=false; build_js=false ;;
    --clean) rm -rf out/ public/; exit ;;
    *)
      echo "unknown flag $1" >&2
      exit 1 ;;
  esac
done

rollup_args="--no-treeshake --no-indent"
emcc_args="-O0"
if [[ "$prod_build" == "true" ]]; then
  rollup_args="-p rollup-plugin-terser"
  emcc_args="-O3 --closure 1"
fi

if [[ "$build_wasm" == "true" ]]; then
  rm -f out/janet.js
  mkdir -p out

  file_args=""
  for file in src/*.janet; do
    file_args="$file_args --embed-file $file@$(basename $file)"
  done
  for file in src/glslisp/src/*.janet; do
    file_args="$file_args --embed-file $file@glslisp/src/$(basename $file)"
  done

  emcc \
    $emcc_args \
    -o out/janet.js \
    -I janet \
    janet/janet.c \
    src/driver.cpp \
    -lembind \
    $file_args \
    -s "EXPORTED_FUNCTIONS=['_main']" \
    -s "EXPORTED_RUNTIME_METHODS=['FS']" \
    -s ALLOW_MEMORY_GROWTH=1 \
    -s AGGRESSIVE_VARIABLE_ELIMINATION=1 \
    -s MODULARIZE \
    -s EXPORT_ES6 \
    -s SINGLE_FILE
fi

if [[ "$build_js" == true ]]; then
  rm -f out/all.js
  mkdir -p out
  (cd ui/ && ./node_modules/.bin/rollup -c $rollup_args)
fi

exists() {
  type $1 &>/dev/null
}

if ! exists sha256sum && exists shasum; then
  sha256sum() {
    shasum -a 256 "$@"
  }
fi

fingerprint() {
  if [[ "$prod_build" == "true" ]]; then
    checksum=$(sha256sum "$1" | cut -f1 -d' ')
    printf "%s.%s" "${checksum:0:16}" "${file#*.}"
  else
    printf '%s' "$(basename "$1")"
  fi
}

staticasset() {
  file=$1
  path=$2
  dest="${path}$(fingerprint "$1")"
  ln -f "$1" "public$dest"
  printf "%s" "$dest"
}

if [[ "$build_html" == true ]]; then
  rm -rf public/
  mkdir -p public/{about,help}

  css=$(staticasset ui/styles/main.css /)
  js=$(staticasset out/all.js /)

  ln -f ui/assets/icons.svg public/icons.svg

  ui/html/home "$css" "$js" > public/index.html
  ui/html/about/index "$css" "$js" > public/about/index.html
  ui/html/help/index "$css" "$js" > public/help/index.html
fi
